<!DOCTYPE html>
<html>
<head>
    <title>SmartFoxServer 2X Test Client - Diagnostic Edition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: inline-block;
            width: 140px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        #log {
            background-color: #000;
            color: #0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
            font-size: 16px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .info-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #0c5460;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #856404;
        }
        .warning-box h3 {
            margin-top: 0;
        }
        .error-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #721c24;
        }
        .error-box h3 {
            margin-top: 0;
        }
        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #155724;
        }
        .success-box h3 {
            margin-top: 0;
        }
        .diagnostic-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .diagnostic-section h3 {
            margin-top: 0;
        }
        .stat {
            display: inline-block;
            margin: 5px 15px 5px 0;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 3px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® SmartFoxServer 2X Test Client</h1>
        <div class="subtitle">Diagnostic Edition with Network Testing</div>
        
        <div class="info-box">
            <h3>âœ… Configuration</h3>
            <p><strong>Server:</strong> 162.120.186.91:60346 (NAT â†’ 8080 WebSocket)</p>
            <p><strong>API File Required:</strong> Rename your downloaded file to <code>SFS2X_API_JS.js</code></p>
        </div>
        
        <div id="apiWarning" class="error-box" style="display:none;">
            <h3>âš ï¸ API Not Loaded</h3>
            <p>The SmartFoxServer API file is missing!</p>
            <p>1. Download the API from SmartFoxServer website</p>
            <p>2. Rename it to <code>SFS2X_API_JS.js</code></p>
            <p>3. Place it in the same folder as this HTML file</p>
        </div>
        
        <div id="diagnosticInfo" class="warning-box" style="display:none;">
            <h3>ğŸ” Diagnostic Information</h3>
            <div id="diagnosticContent"></div>
        </div>
        
        <div id="status" class="status disconnected">
            Status: Disconnected
        </div>
        
        <div class="form-group">
            <label>Server Host:</label>
            <input type="text" id="serverHost" value="162.120.186.91">
        </div>
        
        <div class="form-group">
            <label>Server Port:</label>
            <input type="number" id="serverPort" value="60346">
            <small style="color: #666;">(WebSocket port - must be 60346)</small>
        </div>
        
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="username" placeholder="Enter your username" value="Player1">
        </div>
        
        <div class="form-group">
            <label>Zone Name:</label>
            <input type="text" id="zoneName" placeholder="MyGameZone" value="MyGameZone">
        </div>
        
        <div class="form-group">
            <label>Room Name:</label>
            <input type="text" id="roomName" placeholder="Lobby" value="Lobby">
        </div>
        
        <div class="form-group">
            <label>Connection Timeout:</label>
            <input type="number" id="timeout" value="10" min="5" max="60">
            <small style="color: #666;">seconds</small>
        </div>
        
        <div>
            <button id="connectBtn" onclick="connect()">ğŸ”Œ Connect to Server</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="danger">âŒ Disconnect</button>
            <button onclick="clearLog()">ğŸ§¹ Clear Log</button>
            <button onclick="testNetwork()" class="secondary">ğŸ” Test Network</button>
        </div>
        
        <div class="diagnostic-section">
            <h3>ğŸ“Š Connection Statistics</h3>
            <div id="stats">
                <span class="stat">Attempts: <strong id="attempts">0</strong></span>
                <span class="stat">Successes: <strong id="successes">0</strong></span>
                <span class="stat">Failures: <strong id="failures">0</strong></span>
                <span class="stat">Last Attempt: <strong id="lastAttempt">Never</strong></span>
            </div>
        </div>
        
        <div id="log"></div>
    </div>

    <!-- Load SmartFoxServer 2X JavaScript API -->
    <script src="SFS2X_API_JS.js"></script>
    
    <script>
        var sfs;
        var statusDiv = document.getElementById("status");
        var connectBtn = document.getElementById("connectBtn");
        var disconnectBtn = document.getElementById("disconnectBtn");
        var apiWarning = document.getElementById("apiWarning");
        var diagnosticInfo = document.getElementById("diagnosticInfo");
        var connectionTimeout;
        
        // Statistics
        var stats = {
            attempts: 0,
            successes: 0,
            failures: 0,
            lastAttempt: null
        };
        
        // Check if API loaded
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof SFS2X === 'undefined') {
                    log("âœ— SFS2X API not found!");
                    apiWarning.style.display = 'block';
                    connectBtn.disabled = true;
                } else {
                    log("âœ“ SFS2X API loaded successfully!");
                    log("API Version: " + (SFS2X.API_VERSION || "Unknown"));
                    connectBtn.disabled = false;
                }
            }, 500);
        });
        
        function log(message, level) {
            var logDiv = document.getElementById("log");
            var timestamp = new Date().toLocaleTimeString();
            var color = level === 'error' ? '#ff6b6b' : level === 'warn' ? '#ffd93d' : level === 'success' ? '#6bcf7f' : '#0f0';
            logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById("log").innerHTML = "";
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log("SmartFoxServer 2X Test Client");
            log("Diagnostic Edition");
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log("Ready to connect.");
        }
        
        function updateStatus(state, message) {
            if (state === 'connected') {
                statusDiv.className = "status connected";
                statusDiv.innerHTML = "Status: Connected âœ“";
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (state === 'connecting') {
                statusDiv.className = "status connecting";
                statusDiv.innerHTML = "Status: Connecting" + (message ? " - " + message : "...");
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = "status disconnected";
                statusDiv.innerHTML = "Status: Disconnected" + (message ? " - " + message : "");
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function updateStats() {
            document.getElementById("attempts").textContent = stats.attempts;
            document.getElementById("successes").textContent = stats.successes;
            document.getElementById("failures").textContent = stats.failures;
            document.getElementById("lastAttempt").textContent = stats.lastAttempt || "Never";
        }
        
        function showDiagnostic(message) {
            var content = document.getElementById("diagnosticContent");
            content.innerHTML = message;
            diagnosticInfo.style.display = 'block';
        }
        
        function hideDiagnostic() {
            diagnosticInfo.style.display = 'none';
        }
        
        function testNetwork() {
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log("ğŸ” Running Network Diagnostics...", "warn");
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            
            var host = document.getElementById("serverHost").value;
            var port = document.getElementById("serverPort").value;
            
            // Test 1: Check if we can reach the server
            log("Test 1: Attempting HTTP request to server...");
            
            var testUrl = "http://" + host + ":" + port + "/crossdomain.xml";
            var img = new Image();
            var startTime = Date.now();
            
            img.onerror = function() {
                var elapsed = Date.now() - startTime;
                log("âš ï¸ HTTP test inconclusive (" + elapsed + "ms)", "warn");
                log("This is normal - the server may not serve this file.");
            };
            
            img.onload = function() {
                var elapsed = Date.now() - startTime;
                log("âœ“ HTTP response received (" + elapsed + "ms)", "success");
            };
            
            img.src = testUrl + "?t=" + Date.now();
            
            // Test 2: Check browser capabilities
            setTimeout(function() {
                log("");
                log("Test 2: Browser Capabilities");
                log("  WebSocket support: " + (window.WebSocket ? "âœ“ Yes" : "âœ— No"), window.WebSocket ? "success" : "error");
                log("  Fetch API: " + (window.fetch ? "âœ“ Yes" : "âœ— No"));
                log("  Local Storage: " + (window.localStorage ? "âœ“ Yes" : "âœ— No"));
                log("  User Agent: " + navigator.userAgent);
                log("");
                log("Test 3: Configuration Check");
                log("  Server: " + host + ":" + port);
                log("  WebSocket URL: ws://" + host + ":" + port);
                log("  Expected internal: 0.0.0.0:8080");
                log("  NAT forwarding: " + port + " â†’ 8080");
                log("");
                log("âœ“ Diagnostics complete!");
                log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            }, 1000);
        }
        
        function connect() {
            if (typeof SFS2X === 'undefined') {
                log("âœ— SmartFoxServer API not loaded!", "error");
                apiWarning.style.display = 'block';
                return;
            }
            
            hideDiagnostic();
            stats.attempts++;
            stats.lastAttempt = new Date().toLocaleTimeString();
            updateStats();
            
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log("ğŸš€ Initializing connection...");
            
            var host = document.getElementById("serverHost").value;
            var port = parseInt(document.getElementById("serverPort").value);
            var zone = document.getElementById("zoneName").value || "MyGameZone";
            var timeout = parseInt(document.getElementById("timeout").value) * 1000;
            
            log("Configuration:");
            log("  Host: " + host);
            log("  Port: " + port + " (external)");
            log("  Internal Port: 8080 (via NAT)");
            log("  Zone: " + zone);
            log("  Timeout: " + (timeout/1000) + " seconds");
            log("  Protocol: WebSocket");
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            
            updateStatus('connecting', 'Initializing...');
            
            // Create SmartFox instance
            sfs = new SFS2X.SmartFox({debug: false});
            
            // Set connection timeout
            connectionTimeout = setTimeout(function() {
                if (sfs && !sfs.isConnected) {
                    log("");
                    log("âœ— Connection timeout after " + (timeout/1000) + " seconds!", "error");
                    log("");
                    log("Common Issues:");
                    log("  1. Windows Firewall blocking port 8080");
                    log("  2. SmartFoxServer not running");
                    log("  3. WebSocket not enabled in SFS config");
                    log("  4. NAT port forwarding incorrect");
                    log("  5. 'Allowed client origins' blocking connection");
                    log("");
                    showDiagnostic(
                        "<strong>Connection Timeout!</strong><br><br>" +
                        "The client couldn't connect within " + (timeout/1000) + " seconds.<br><br>" +
                        "<strong>Next Steps:</strong><br>" +
                        "1. Verify SFS service is running: <code>sc query sfs2x-service</code><br>" +
                        "2. Check Windows Firewall allows port 8080<br>" +
                        "3. Check SFS logs: <code>C:\\Users\\v2cloud\\SmartFoxServer_2X\\SFS2X\\logs\\</code><br>" +
                        "4. In Admin Tool â†’ Web Server â†’ Add '*' to 'Allowed client origins'<br>" +
                        "5. Restart SFS service after any config changes"
                    );
                    updateStatus('disconnected', 'Timeout');
                    stats.failures++;
                    updateStats();
                    if (sfs) {
                        sfs.disconnect();
                    }
                }
            }, timeout);
            
            // Add event listeners
            sfs.addEventListener(SFS2X.SFSEvent.CONNECTION, onConnection, this);
            sfs.addEventListener(SFS2X.SFSEvent.CONNECTION_LOST, onConnectionLost, this);
            sfs.addEventListener(SFS2X.SFSEvent.LOGIN, onLogin, this);
            sfs.addEventListener(SFS2X.SFSEvent.LOGIN_ERROR, onLoginError, this);
            sfs.addEventListener(SFS2X.SFSEvent.ROOM_JOIN, onRoomJoin, this);
            sfs.addEventListener(SFS2X.SFSEvent.ROOM_JOIN_ERROR, onRoomJoinError, this);
            sfs.addEventListener(SFS2X.SFSEvent.USER_ENTER_ROOM, onUserEnterRoom, this);
            sfs.addEventListener(SFS2X.SFSEvent.USER_EXIT_ROOM, onUserExitRoom, this);
            
            // Connect to SmartFoxServer
            var config = {
                host: host,
                port: port,
                useSSL: false,
                zone: zone,
                debug: false
            };
            
            updateStatus('connecting', 'Connecting to ' + host + ':' + port);
            log("Connecting to " + host + ":" + port + "...");
            
            try {
                sfs.connect(config);
            } catch (error) {
                clearTimeout(connectionTimeout);
                log("âœ— Connection error: " + error.message, "error");
                updateStatus('disconnected', 'Error');
                stats.failures++;
                updateStats();
            }
        }
        
        function disconnect() {
            if (connectionTimeout) {
                clearTimeout(connectionTimeout);
            }
            if (sfs && sfs.isConnected) {
                log("Disconnecting from server...");
                sfs.disconnect();
            }
        }
        
        function onConnection(event) {
            clearTimeout(connectionTimeout);
            
            if (event.success) {
                log("âœ“ TCP connection established!", "success");
                log("WebSocket handshake successful!");
                updateStatus('connecting', 'Logging in...');
                
                var username = document.getElementById("username").value || "Player" + Math.floor(Math.random() * 1000);
                log("Attempting login as: " + username);
                sfs.send(new SFS2X.LoginRequest(username));
            } else {
                log("âœ— Connection failed!", "error");
                log("Error: " + (event.errorMessage || "Unknown error"), "error");
                log("");
                log("Troubleshooting Steps:");
                log("  1. Check if SFS service is running");
                log("  2. Verify port 8080 is open in Windows Firewall");
                log("  3. Test NAT forwarding: 60346 â†’ 8080");
                log("  4. Check SFS logs for errors");
                log("  5. Verify WebSocket is enabled in Server Configurator");
                updateStatus('disconnected', event.errorMessage);
                stats.failures++;
                updateStats();
            }
        }
        
        function onConnectionLost(event) {
            clearTimeout(connectionTimeout);
            log("âœ— Connection lost!", "error");
            log("Reason: " + event.reason, "error");
            updateStatus('disconnected', 'Connection lost');
            stats.failures++;
            updateStats();
        }
        
        function onLogin(event) {
            log("âœ“ Login successful!", "success");
            log("  User ID: " + event.user.id);
            log("  Username: " + event.user.name);
            log("  Zone: " + event.zone);
            stats.successes++;
            updateStats();
            updateStatus('connected');
            
            var roomName = document.getElementById("roomName").value || "Lobby";
            log("Joining room: '" + roomName + "'...");
            sfs.send(new SFS2X.JoinRoomRequest(roomName));
        }
        
        function onLoginError(event) {
            log("âœ— Login error!", "error");
            log("  Message: " + event.errorMessage, "error");
            log("  Code: " + event.errorCode, "error");
            log("");
            log("Check that Zone '" + document.getElementById("zoneName").value + "' exists in Admin Tool.");
            updateStatus('disconnected', 'Login failed');
            stats.failures++;
            updateStats();
        }
        
        function onRoomJoin(event) {
            log("âœ“ Successfully joined room: " + event.room.name, "success");
            log("  Room ID: " + event.room.id);
            log("  Capacity: " + event.room.getUserList().length + "/" + event.room.getCapacity());
            log("");
            log("ğŸ‘¥ Users in room:");
            event.room.getUserList().forEach(function(user) {
                log("  â€¢ " + user.name + (user.isItMe ? " â­ (YOU)" : ""));
            });
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log("ğŸ‰ SUCCESS! FULLY CONNECTED!", "success");
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
        
        function onRoomJoinError(event) {
            log("âœ— Failed to join room!", "error");
            log("  Error: " + event.errorMessage, "error");
            log("  Code: " + event.errorCode, "error");
            log("");
            log("Make sure room '" + document.getElementById("roomName").value + "' exists.");
            log("Create it in: Admin Tool â†’ Zone Monitor â†’ Create Room");
        }
        
        function onUserEnterRoom(event) {
            var user = event.user;
            if (!user.isItMe) {
                log("â†’ " + user.name + " joined the room", "success");
            }
        }
        
        function onUserExitRoom(event) {
            var user = event.user;
            log("â† " + user.name + " left the room", "warn");
        }
        
        // Initial log
        log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        log("SmartFoxServer 2X Test Client");
        log("Diagnostic Edition v1.0");
        log("Server: 162.120.186.91:60346");
        log("NAT Mapping: 60346 â†’ 8080 (WebSocket)");
        log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        log("Checking for API file...");
    </script>
</body>
</html>
